const e=Symbol(),t=(e,...n)=>{if(!n.length)return e;const s=n.shift();if(r(e)&&r(s))for(const n in s)r(s[n])?(e[n]||Object.assign(e,{[n]:{}}),t(e[n],s[n])):Array.isArray(s[n])?e[n]=s[n].map((e=>r(e)?t({},e):e)):Object.assign(e,{[n]:s[n]});return t(e,...n)},r=e=>e&&"object"==typeof e&&!Array.isArray(e),n=(e,t,r)=>{if("object"!=typeof e)return;let n=0;for(;n<t.length-1;n++)if("object"!=typeof(e=e[t[n]]))return;e[t[n]]=r};function s(t,r){const s=function(e,t,r){const s=(t,r)=>{r[e]&&(r.getElement().removeEventListener("input",r[e]),delete r[e])};return{update:(o,c,{executeExpression:i})=>{const a=c.getElement(),l=!c[e];if(l&&("DIV"!==a.tagName||!a.hasAttribute("contenteditable"))&&"INPUT"!==a.tagName&&"SELECT"!==a.tagName&&"TEXTAREA"!==a.tagName)return void console.warn("Doars: `sync` directive must be placed on an `<input>`, `<select>`, `<textarea>` tag, or a content editable `div`.");const u=c.getValue();if(!/^[_$a-z]{1}[._$a-z0-9]{0,}$/i.test(u))return s(0,c),void console.warn("Doars: `sync` directive's value not a valid variable name: \""+u+'".');let d=u;if(d.startsWith(r)&&(d=d.substring(r.length)),d=d.split("."),l){const{data:r,id:s,path:l}=t(0,c);let v;switch(a.tagName){case"DIV":v=()=>(n(r,d,a.innerText),!0);break;case"INPUT":v=()=>{if("checkbox"===a.type){const e=i(o,c.clone(),u);if(a.checked){if(!e)return n(r,d,[a.value]),!0;if(!e.includes(a.value))return e.push(a.value),!0}else if(e){const t=e.indexOf(a.value);if(t>=0)return e.splice(t,1),!0}}else{if("radio"!==a.type)return n(r,d,a.value),!0;{const e=i(o,c.clone(),u);if(a.checked){if(e!==a.value)return n(r,d,a.value),!0}else if(e===a.value)return n(r,d,null),!0}}return!1};break;case"TEXTAREA":v=()=>(n(r,d,a.value),!0);break;case"SELECT":v=()=>{if(a.multiple){const e=[];for(const t of a.selectedOptions)e.push(t.value);return n(r,d,e),!0}return n(r,d,a.selectedOptions[0].value),!0}}const p=()=>{v()&&o.getLibrary().update([{id:s,path:l}])};a.addEventListener("input",p),c[e]=p}const v=i(o,c,u);switch(a.tagName){case"DIV":case"TEXTAREA":v!==a.innerText&&(a.innerText=v);break;case"INPUT":if("checkbox"===a.type){const e=v.includes(a.value);a.checked!==e&&(a.checked=e,e?a.setAttribute("checked",""):a.removeAttribute("checked"))}else if("radio"===a.type){const e=v===a.value;a.checked!==e&&(a.checked=e,e?a.setAttribute("checked",""):a.removeAttribute("checked"))}else v!==a.value&&a.setAttribute("value",v);break;case"SELECT":for(const e of Array.from(a.options)){const t=Array.isArray(v)?v.includes(e.value):v===e.value;e.selected!==t&&(e.selected=t,t?e.setAttribute("selected",""):e.removeAttribute("selected"))}}},destroy:s}}(e,((e,n)=>{let s=n.getValue();return s.startsWith("$store.")&&(s=s.substring("$store.".length)),{data:r,id:t,path:s}}),"$store.");return s.name="sync-store",s}const o=["apply","construct","defineProperty","deleteProperty","get","getOwnPropertyDescriptor","getPrototypeOf","isExtensible","ownKeys","preventExtensions","set","setPrototypeOf"];class c extends class{constructor(){let e={};this.addEventListener=(t,r,n=null)=>{t in e||(e[t]=[]),e[t].push({callback:r,options:n})},this.removeEventListener=(t,r)=>{if(!Object.keys(e).includes(t))return;const n=e[t];let s=-1;for(let e=0;e<n.length;e++)if(n[e].callback===r){s=e;break}s<0||(n.splice(s,1),0===Object.keys(n).length&&delete e[t])},this.removeEventListeners=t=>{t&&delete e[t]},this.removeAllEventListeners=()=>{e={}},this.dispatchEvent=(t,r,n=null)=>{if(!e[t])return;const s=e[t];for(let e=0;e<s.length;e++){const t=n&&n.reverse?s[s.length-(e+1)]:s[e];t.options&&t.options.once&&s.splice(e,1),t.callback(...r)}}}}{constructor(e={}){super(),e=Object.assign({delete:!0,get:!0,set:!0},e);const t=new WeakMap;this.add=(r,n=[])=>{if(t.has(r))return t.get(r);for(const e in r)r[e]&&"object"==typeof r[e]&&(r[e]=this.add(r[e],[...n,e]));const s={};e.delete&&(s.deleteProperty=(e,t)=>{if(!Reflect.has(e,t))return!0;this.remove(e,t);const r=Reflect.deleteProperty(e,t);return r&&this.dispatchEvent("delete",[e,Array.isArray(e)?[...n]:[...n,t]]),r}),e.get&&(s.get=(e,t,r)=>(t!==Symbol.unscopables&&this.dispatchEvent("get",[e,[...n,t],r]),Reflect.get(e,t,r))),e.set&&(s.set=(e,t,r,s)=>(e[t]===r||("object"==typeof r&&(r=this.add(r,[...n,t])),e[t]=r,this.dispatchEvent("set",[e,Array.isArray(e)?[...n]:[...n,t],r,s])),!0));const c=function(e,t){let r=!1;const n={};for(const e of o)n[e]=(...n)=>{if(!r)return e in t?t[e](...n):Reflect[e](...n);console.error("illegal operation attempted on a revoked proxy")};return{proxy:new Proxy(e,n),revoke:()=>{r=!0}}}(r,s);return t.set(c,r),c.proxy},this.remove=e=>{if(!t.has(e))return;const r=t.get(e);t.delete(r);for(const e in r.proxy)"object"==typeof r.proxy[e]&&this.remove(r.proxy[e]);r.revoke()}}}export default class{constructor(e,r=null,n={}){let o,i,a,l,u;r=t({deconstruct:!1},r),e.addEventListener("enabling",(()=>{i=t({},n),l=new c,u=l.add(i);const d=Symbol();o=function(e,t,r,n){return{deconstruct:!!e.deconstruct,name:"$store",create:(e,s,o,{RevocableProxy:c})=>{const i=(e,r)=>o(t,r.join(".")),a=(e,r)=>s.accessed(t,r.join(".")),l=(e,r)=>o(t,r.join("."));n.addEventListener("delete",i),n.addEventListener("get",a),n.addEventListener("set",l);const u=c(r,{});return{value:u.proxy,destroy:()=>{n.removeEventListener("delete",i),n.removeEventListener("get",a),n.removeEventListener("set",l),u.revoke()}}}}}(r,d,u,l);const v=e.getContexts();let p=0;for(let e=0;e<v.length;e++)if("$state"===v[e].name){p=e;break}e.addContexts(p,o),a=s(d,u),e.addDirectives(-1,a)})),e.addEventListener("disabling",(()=>{e.removeContexts(o),e.removeDirective(a),u=null,l.remove(i),l=null,i=null,a=null,o=null}))}}
